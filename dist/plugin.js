var E=Object.defineProperty,R=(t,e,n)=>e in t?E(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,P=(t,e,n)=>(R(t,typeof e!="symbol"?e+"":e,n),n),x=(t,e,n)=>new Promise((r,o)=>{var a=s=>{try{i(n.next(s))}catch(m){o(m)}},g=s=>{try{i(n.throw(s))}catch(m){o(m)}},i=s=>s.done?r(s.value):Promise.resolve(s.value).then(a,g);i((n=n.apply(t,e)).next())}),f;(t=>{const e=new Map;function n(o,a){var g;return(g=e.get(o))==null?void 0:g.get(a)}t.getDelegate=n;function r(o,a,g){e.has(o)||e.set(o,new Map);const i=e.get(o);i.has(a)||i.set(a,g)}t.register=r})(f||(f={}));const u=class{constructor(t,e){this.name=t,this.definitions=e}static get current(){return u.currentSide}static set current(t){if(u.currentSide!=null)throw new Error("Logical side can be declared only once.");u.currentSide=t}static register(t){return this.sides.set(t.getName(),t),t}static byName(t){return this.sides.get(t)}getName(){return this.name}beginListening(t,e){const n=r=>{var o,a,g;if(this.definitions.shouldHandle!=null&&!this.definitions.shouldHandle(r))return;const i=(g=(a=(o=this.definitions).messageGetter)==null?void 0:a.call(o,r))!=null?g:r;if(i.type!=="response"){const s=t==null?void 0:t.byName(i.type);if(s==null)t!=null&&console.warn("Unknown message received ->",i.type);else{const m=u.byName(i.from),d=s.handle(i.payload,m);if(d!==void 0){const v=N=>{const I=u.current,h=f.getDelegate(I,m);h==null||h({from:u.current.getName(),type:"response",requestId:i.requestId,payload:N})};typeof(d==null?void 0:d.then)=="function"?d.then(v):v(d)}}}e!=null&&e(i)&&this.definitions.detachListener(n)};this.definitions.attachListener(n)}};let l=u;P(l,"currentSide"),P(l,"sides",new Map);function C(){const t=new Array(36);for(let e=0;e<36;e++)t[e]=Math.floor(Math.random()*16);return t[14]=4,t[19]=t[19]&=-5,t[19]=t[19]|=8,t[8]=t[13]=t[18]=t[23]="-",t.map(e=>e.toString(16)).join("")}class y{constructor(e){this.name=e}getName(){return this.name}createTransportMessage(e){const n=l.current;return{requestId:C(),type:this.getName(),from:n.getName(),payload:e}}sendTransportMessage(e){const n=l.current,r=this.receivingSide(),o=f.getDelegate(n,r);if(!o)throw new Error(`Transportation from ${n.getName()} to ${r.getName()} is not supported.`);return o(e),e}send(e){const n=this.createTransportMessage(e);return this.sendTransportMessage(n)}request(e){return x(this,null,function*(){const n=this.createTransportMessage(e),r=new Promise(o=>{l.current.beginListening(null,a=>a.requestId===n.requestId?(o(a.payload),!0):!1)});return this.sendTransportMessage(n),r})}}class M{constructor(){P(this,"registry",new Map)}byName(e){return this.registry.get(e)}register(e){return this.registry.set(e.getName(),e),e}}function O(t){return e=>{l.current=e,e.beginListening(t.messagesRegistry),t.initTransports(f.register)}}var c;(t=>{t.PLUGIN=l.register(new l("Plugin",{attachListener:e=>figma.ui.on("message",e),detachListener:e=>figma.ui.off("message",e)})),t.UI=l.register(new l("UI",{shouldHandle:e=>{var n;return((n=e.data)==null?void 0:n.pluginId)!=null},messageGetter:e=>e.data.pluginMessage,attachListener:e=>window.addEventListener("message",e),detachListener:e=>window.removeEventListener("message",e)}))})(c||(c={}));class _ extends y{receivingSide(){return c.PLUGIN}handle(e,n){if(figma.editorType==="figma"){const r=figma.createRectangle();r.x=0,r.y=0,r.name="Plugin Rectangle # "+Math.floor(Math.random()*9999),r.fills=[{type:"SOLID",color:{r:Math.random(),g:Math.random(),b:Math.random()}}],r.resize(e.width,e.height),figma.currentPage.appendChild(r),figma.viewport.scrollAndZoomIntoView([r]),figma.closePlugin()}}}class T extends y{constructor(e){super("hello-"+e.getName()),this.side=e}receivingSide(){return this.side}handle(e,n){console.log(`${n.getName()} said "${e.text}"`)}}class $ extends y{receivingSide(){return c.PLUGIN}handle(e,n){var a,g,i;console.log(" payload",e);const r=e.serverUrl;console.log(" serverUrl",r),console.log(n.getName(),"has pinged us!");const o=figma.currentPage.selection;if(o.length>0){const s=o[0];console.log(" selectedNode.parent?.name",(a=s.parent)==null?void 0:a.name),console.log(s.name),console.log("Children:",((i=(g=s==null?void 0:s.children)==null?void 0:g[0])==null?void 0:i.name)||"No children");const m={format:"PNG",constraint:{type:"SCALE",value:1}},d={format:"SVG_STRING"},v={format:"JSON_REST_V1"};return(async()=>{var N,I,h;for(const L of[m,d,v]){console.log(" ",L.format);const w=await s.exportAsync(L),U=L.format;let b="";((N=s==null?void 0:s.children)==null?void 0:N.length)==1&&(b=(I=s==null?void 0:s.children[0])==null?void 0:I.name);const G=`${r}?nodeName=${encodeURIComponent(s.name||"")}&parentNodeName=${encodeURIComponent(((h=s.parent)==null?void 0:h.name)||"")}&childNodeName=${encodeURIComponent(b)}&componentName=${encodeURIComponent(e.componentName)}&breakpoint=${encodeURIComponent(e.breakpoint)}&format=${encodeURIComponent(U)}`;console.log(" sending to url",G),await fetch(G,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:U==="PNG"?Array.from(w):w})}).then(p=>p.text()).then(p=>console.log(`send the request to the server - response wa: ${p}`,U)).catch(p=>console.error(U,p))}})(),"Send to server"}else return"Please select something"}}class q extends y{receivingSide(){return c.PLUGIN}handle(e,n){const r=JSON.stringify({serverUrl:e.serverUrl,componentName:e.componentName,breakpoint:e.breakpoint});figma.root.setPluginData("config",r)}}class H extends y{receivingSide(){return c.PLUGIN}handle(e,n){const r=figma.root.getPluginData("config");if(!r)return{serverUrl:"",componentName:"",breakpoint:"BRONZE"};const o=JSON.parse(r);return{serverUrl:o.serverUrl,componentName:o.componentName,breakpoint:o.breakpoint}}}var S;(t=>{t.registry=new M,t.EXPORT_REQUEST=t.registry.register(new $("export-request")),t.SET_CONFIG=t.registry.register(new q("set-config")),t.GET_CONFIG=t.registry.register(new H("get-config")),t.HELLO_PLUGIN=t.registry.register(new T(c.PLUGIN)),t.HELLO_UI=t.registry.register(new T(c.UI)),t.CREATE_RECT=t.registry.register(new _("create-rect"))})(S||(S={}));const D=O({messagesRegistry:S.registry,initTransports:function(t){t(c.PLUGIN,c.UI,e=>{figma.ui.postMessage(e)}),t(c.UI,c.PLUGIN,e=>{parent.postMessage({pluginMessage:e},"*")})}});async function A(){D(c.PLUGIN),figma.editorType==="figma"&&figma.showUI(__html__,{width:800,height:650,title:"send-compnent-to-server"}),console.log("Bootstrapped @",l.current.getName()),S.HELLO_UI.send({text:"Hey there, UI!"})}A();
