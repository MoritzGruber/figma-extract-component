var G=Object.defineProperty,x=(t,e,r)=>e in t?G(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,P=(t,e,r)=>(x(t,typeof e!="symbol"?e+"":e,r),r),O=(t,e,r)=>new Promise((n,o)=>{var a=g=>{try{s(r.next(g))}catch(u){o(u)}},c=g=>{try{s(r.throw(g))}catch(u){o(u)}},s=g=>g.done?n(g.value):Promise.resolve(g.value).then(a,c);s((r=r.apply(t,e)).next())}),I;(t=>{const e=new Map;function r(o,a){var c;return(c=e.get(o))==null?void 0:c.get(a)}t.getDelegate=r;function n(o,a,c){e.has(o)||e.set(o,new Map);const s=e.get(o);s.has(a)||s.set(a,c)}t.register=n})(I||(I={}));const y=class{constructor(t,e){this.name=t,this.definitions=e}static get current(){return y.currentSide}static set current(t){if(y.currentSide!=null)throw new Error("Logical side can be declared only once.");y.currentSide=t}static register(t){return this.sides.set(t.getName(),t),t}static byName(t){return this.sides.get(t)}getName(){return this.name}beginListening(t,e){const r=n=>{var o,a,c;if(this.definitions.shouldHandle!=null&&!this.definitions.shouldHandle(n))return;const s=(c=(a=(o=this.definitions).messageGetter)==null?void 0:a.call(o,n))!=null?c:n;if(s.type!=="response"){const g=t==null?void 0:t.byName(s.type);if(g==null)t!=null&&console.warn("Unknown message received ->",s.type);else{const u=y.byName(s.from),i=g.handle(s.payload,u);if(i!==void 0){const p=d=>{const f=y.current,h=I.getDelegate(f,u);h==null||h({from:y.current.getName(),type:"response",requestId:s.requestId,payload:d})};typeof(i==null?void 0:i.then)=="function"?i.then(p):p(i)}}}e!=null&&e(s)&&this.definitions.detachListener(r)};this.definitions.attachListener(r)}};let m=y;P(m,"currentSide"),P(m,"sides",new Map);function R(){const t=new Array(36);for(let e=0;e<36;e++)t[e]=Math.floor(Math.random()*16);return t[14]=4,t[19]=t[19]&=-5,t[19]=t[19]|=8,t[8]=t[13]=t[18]=t[23]="-",t.map(e=>e.toString(16)).join("")}class L{constructor(e){this.name=e}getName(){return this.name}createTransportMessage(e){const r=m.current;return{requestId:R(),type:this.getName(),from:r.getName(),payload:e}}sendTransportMessage(e){const r=m.current,n=this.receivingSide(),o=I.getDelegate(r,n);if(!o)throw new Error(`Transportation from ${r.getName()} to ${n.getName()} is not supported.`);return o(e),e}send(e){const r=this.createTransportMessage(e);return this.sendTransportMessage(r)}request(e){return O(this,null,function*(){const r=this.createTransportMessage(e),n=new Promise(o=>{m.current.beginListening(null,a=>a.requestId===r.requestId?(o(a.payload),!0):!1)});return this.sendTransportMessage(r),n})}}class _{constructor(){P(this,"registry",new Map)}byName(e){return this.registry.get(e)}register(e){return this.registry.set(e.getName(),e),e}}function M(t){return e=>{m.current=e,e.beginListening(t.messagesRegistry),t.initTransports(I.register)}}var l;(t=>{t.PLUGIN=m.register(new m("Plugin",{attachListener:e=>figma.ui.on("message",e),detachListener:e=>figma.ui.off("message",e)})),t.UI=m.register(new m("UI",{shouldHandle:e=>{var r;return((r=e.data)==null?void 0:r.pluginId)!=null},messageGetter:e=>e.data.pluginMessage,attachListener:e=>window.addEventListener("message",e),detachListener:e=>window.removeEventListener("message",e)}))})(l||(l={}));class $ extends L{receivingSide(){return l.PLUGIN}handle(e,r){if(figma.editorType==="figma"){const n=figma.createRectangle();n.x=0,n.y=0,n.name="Plugin Rectangle # "+Math.floor(Math.random()*9999),n.fills=[{type:"SOLID",color:{r:Math.random(),g:Math.random(),b:Math.random()}}],n.resize(e.width,e.height),figma.currentPage.appendChild(n),figma.viewport.scrollAndZoomIntoView([n]),figma.closePlugin()}}}class T extends L{constructor(e){super("hello-"+e.getName()),this.side=e}receivingSide(){return this.side}handle(e,r){if(r===l.PLUGIN){const n=new CustomEvent("pluginmsg",{detail:e.text});document.dispatchEvent(n)}console.log(`${r.getName()} said "${e.text}"`)}}function A(t){let e="";const r=n=>n===n.toUpperCase();for(let n=0;n<t.length;n++){const o=t[n];if(o!==" "){if(n===0){e+=o.toUpperCase();continue}if(t[n-1]===" "){e+=o.toUpperCase();continue}if(r(o)){const a=t[n-1];if(r(a)){if(n+1<t.length){const c=t[n+1];if(!r(c)){e+=o.toUpperCase();continue}}e+=o.toLowerCase();continue}e+=o.toUpperCase();continue}e+=o.toLowerCase()}}return e}class D extends L{receivingSide(){return l.PLUGIN}handle(e,r){console.log(" payload",e);const n=e.serverUrl;console.log(" serverUrl",n),console.log(r.getName(),"has pinged us!");const o=figma.currentPage.selection,a=`${e.componentName}`.toLowerCase()==="auto";if(o.length>0){const c=async(s,g,u)=>{const i={format:"PNG",constraint:{type:"SCALE",value:1}},p={format:"SVG_STRING"},d={format:"JSON_REST_V1"};await(async()=>{var f,h,N;for(const w of[i,p,d]){console.log(" ",w.format);const b=await s.exportAsync(w),S=w.format;let C="";((f=s==null?void 0:s.children)==null?void 0:f.length)==1&&(C=(h=s==null?void 0:s.children[0])==null?void 0:h.name);const E=`${n}?nodeName=${encodeURIComponent(s.name||"")}&parentNodeName=${encodeURIComponent(((N=s.parent)==null?void 0:N.name)||"")}&childNodeName=${encodeURIComponent(C)}&componentName=${encodeURIComponent(A(g))}&breakpoint=${encodeURIComponent(u)}&format=${encodeURIComponent(S)}`;console.log(" sending to url",E),await fetch(E,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:S==="PNG"?Array.from(b):b})}).then(v=>v.text()).then(v=>console.log(`send the request to the server - response wa: ${v}`,S)).catch(v=>console.error(S,v))}})()};if(a){const s={};console.log(" selection",o);const g=["BRONZE","SILVER","GOLD","PLATINUM","DIAMOND"];o.forEach(i=>{var p,d;(p=i==null?void 0:i.children)==null||p.map(f=>{const h=`${f.name}`.toUpperCase();if(g.includes(h)){const N=i.name;s[`${N}_x_${h}`]=f}}),console.log(" in selected node ",i==null?void 0:i.name,(d=i==null?void 0:i.children)==null?void 0:d.map(f=>f.name))});const u=Object.keys(s);return(async()=>{for(const i of u){console.log(` starting ${i}`),U.HELLO_UI.send({text:`starting ${i}`});const[p,d]=i.split("_x_");await c(s[i],p,d),U.HELLO_UI.send({text:`done ${i}`}),console.log(" done with ",i)}U.HELLO_UI.send({text:"done with all selected components"})})(),"Auto mode is not supported yet"}else return c(o[0],e.componentName,e.breakpoint),"Send to server"}else return"Please select something"}}class q extends L{receivingSide(){return l.PLUGIN}handle(e,r){const n=JSON.stringify({serverUrl:e.serverUrl,componentName:e.componentName,breakpoint:e.breakpoint,mode:e.mode});figma.root.setPluginData("config",n)}}class H extends L{receivingSide(){return l.PLUGIN}handle(e,r){const n=figma.root.getPluginData("config");if(!n)return{serverUrl:"",componentName:"",breakpoint:"BRONZE",mode:"AUTO"};const o=JSON.parse(n);return{serverUrl:o.serverUrl,componentName:o.componentName,breakpoint:o.breakpoint,mode:o.mode}}}var U;(t=>{t.registry=new _,t.EXPORT_REQUEST=t.registry.register(new D("export-request")),t.SET_CONFIG=t.registry.register(new q("set-config")),t.GET_CONFIG=t.registry.register(new H("get-config")),t.HELLO_PLUGIN=t.registry.register(new T(l.PLUGIN)),t.HELLO_UI=t.registry.register(new T(l.UI)),t.CREATE_RECT=t.registry.register(new $("create-rect"))})(U||(U={}));const J=M({messagesRegistry:U.registry,initTransports:function(t){t(l.PLUGIN,l.UI,e=>{figma.ui.postMessage(e)}),t(l.UI,l.PLUGIN,e=>{parent.postMessage({pluginMessage:e},"*")})}});async function V(){J(l.PLUGIN),figma.editorType==="figma"&&figma.showUI(__html__,{width:800,height:650,title:"Send compnents to your server"}),console.log("Bootstrapped @",m.current.getName())}V();
